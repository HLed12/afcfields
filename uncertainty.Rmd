---
title: "uncertainty"
author: "Harrison Leduc"
date: "2024-04-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Data and Insight
```{r}
library(dplyr)
library(sf)
library(terra)
library(parallel)

data_dir <- here::here("external/afcdata")

# temporary work around
#data_dir <- file.path("~/external/afcdata")

flds <- sfarrow::st_read_parquet(
  file.path(data_dir, "mapped_fields_final.parquet"))

ctlg <- readr::read_csv(
  file.path(data_dir, "label_catalog_allclasses.csv"))

#Data check
#names(ctlg)

#length(unique(ctlg$assignment_id)) == nrow(ctlg)

#length(unique(ctlg$name))

```

Spatial Features/Characteristics
```{r}
library(ggplot2)

polybox <- function(x, y, w = 0.0025, crs = 4326) {
  dw <- cbind(c(x - w, x + w, x + w, x - w, x - w),
              c(y + w, y + w, y - w, y - w, y + w))
  st_sf(geometry = st_sfc(st_polygon(list(dw))), crs = crs)
}

set.seed(2)
site <- ctlg %>% 
  filter(nflds > 0) %>% 
  sample_n(1) %>% 
  select(name, assignment_id, nflds, farea, x, y) %>% 
  mutate(polybox(x, y)) %>% 
  st_as_sf()

p <- ggplot() +
  geom_sf(data = site) +
  theme_linedraw()
p
```

Digitized Boundaries
```{r}
ctlg %>% 
  mutate(flds = ifelse(nflds > 0, 1, nflds)) %>% 
  group_by(Class) %>% 
  summarize(hasflds = sum(flds),
            noflds = length(flds[flds == 0]))

site_flds <- flds %>% 
  filter(assignment_id == site$assignment_id)
site_flds

site

p2 <- p +
  geom_sf(data = site_flds, fill = "transparent", color = "red", lwd = 0.5)
p2
```

Label Uncertainty
```{r}
sites_mapped_gt2_test <- ctlg %>%
  group_by(Class, name) %>%
  count() %>%
  ungroup() %>%
  filter(n > 2)
sites_mapped_gt2_test

multi_site_list <- lapply(1:100, function(x) {

#multi_site_list <- lapply(1:nrow(sites_mapped_gt2_test), function(x) {
  multi_site_test <- sites_mapped_gt2_test %>% slice(x)

# Filter the associations for the selected site
  multi_site_assns_test <- ctlg %>% filter(name == multi_site_test$name)

# Create an empty raster with the same extent as the target site
  target_test <- multi_site_assns_test %>%
    slice(1) %>%
    mutate(polybox(x, y)) %>%
    st_as_sf()

  # Rasterize at 224x224 pixels
  r_test <- rast(ext(target_test), nrows = 224, ncols = 224, crs = "EPSG:4326")
  values(r_test) <- 0

  # Process each association
  multi_site_assnsr_test <- lapply(1:nrow(multi_site_assns_test), function(x) {
    assn_test <- multi_site_assns_test[x, ]
    if (assn_test$nflds > 0) {
      assn_flds_test <- flds %>%
        filter(assignment_id == assn_test$assignment_id)
      r_test <- rasterize(assn_flds_test, r_test, background = 0)
    } else {
      r_test
    }
    return(r_test)
  }) %>% do.call(c, .)
})
```

```{r}
thresholds <- seq(0, 1, 0.2)
reclmat <- data.frame(
  lower = thresholds[-length(thresholds)],
  upper = thresholds[-1],
  index = 1:5,
  class = c("No field, high confidence", "No field, medium confidence", "Uncertain", "Field, medium confidence", "Field, high confidence")
)


pfield_test_list <- lapply(1:length(multi_site_list), function(x) {
  app_result <- app(multi_site_list[[x]], sum)
  nlyr_result <- nlyr(multi_site_list[[x]])
  app_result / nlyr_result
})

conf_class_list <- lapply(1:length(pfield_test_list), function(x) {
  classify(pfield_test_list[[x]], rcl = reclmat[, -4], include.lowest = TRUE)
})

# levels doesn't work but categories does
conf_class_list <- lapply(1:length(conf_class_list), function(x) {
  categories(conf_class_list[[x]], value = reclmat[, 3:4])
})

#plot(conf_class_list[[9]], mar = c(0, 1, 0, 12))
```

```{r, warning = FALSE}
conf_table_test <- lapply(1:length(conf_class_list), function(x) {
  freq(conf_class_list[[x]])
})
#conf_table_test[[9]]


nofld_test <- lapply(1:length(pfield_test_list), function(x) {
  mask(1 - pfield_test_list[[x]], pfield_test_list[[x]] < 0.5, maskvalue = 0, updatevalue = 0)
})
#nofld_test[[2]]

fld_test <- lapply(1:length(pfield_test_list), function(x) {
  mask(pfield_test_list[[x]], pfield_test_list[[x]] >= 0.5, maskvalue = 0, updatevalue = 0)
})
# mcLapply attempt below, did not help!
#fld_test <- mclapply(1:length(pfield_test_list), function(x) {
#  mask(pfield_test_list[[x]], pfield_test_list[[x]] >= 0.5, maskvalue = 0, updatevalue = 0)
#}, mc.cores = 4)
#fld_test[[2]]


fld_nofld_conf_test <- lapply(1:length(fld_test), function(x) {
  c(fld_test[[x]], nofld_test[[x]], fld_test[[x]] + nofld_test[[x]])
})
# mcLapply attempt below, did not help!
#fld_nofld_conf_test <- mclapply(1:length(fld_test), function(x) {
#  c(fld_test[[x]], nofld_test[[x]], fld_test[[x]] + nofld_test[[x]])
#}, mc.cores = 4)
#fld_nofld_conf_test[[9]]

fld_nofld_conf_test <- lapply(1:length(fld_nofld_conf_test), function(x) {
  names(fld_nofld_conf_test[[x]]) <- c("field agreement", "no field agreement", "overall agreement")
  return(fld_nofld_conf_test[[x]])
})
#fld_nofld_conf_test[[9]]


#plot(fld_nofld_conf_test[[9]], nr = 1)

#global(fld_nofld_conf_test[[9]][[3]], mean)
```

Example Site
```{r}
set.seed(9)
plot(conf_class_list[[9]], mar = c(0, 1, 0, 12))

conf_table_test[[9]]

fld_nofld_conf_test[[9]]

plot(fld_nofld_conf_test[[9]], nr = 1)

global(fld_nofld_conf_test[[9]][[3]], mean)
```


Overall Analysis
```{r}
site_means <- lapply(1:length(fld_nofld_conf_test), function(x) {
  global(fld_nofld_conf_test[[x]][[3]], mean)
})

overall_mean <- mean(unlist(site_means))
overall_mean

boxplot(unlist(site_means))
```