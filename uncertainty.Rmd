---
title: "uncertainty"
author: "Harrison Leduc"
date: "2024-04-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


Data and Insight
```{r}
library(dplyr)
library(sf)
library(terra)
here
data_dir <- here::here("external/afcdata")
data_dir
# here::here gives "/home/rstudio/afcfields_/external/afcdata"

# temporary work around
data_dir <- file.path("~/external/afcdata")
data_dir

flds <- sfarrow::st_read_parquet(
  file.path(data_dir, "mapped_fields_final.parquet"))

ctlg <- readr::read_csv(
  file.path(data_dir, "label_catalog_allclasses.csv"))

names(ctlg)

length(unique(ctlg$assignment_id)) == nrow(ctlg)

length(unique(ctlg$name))

```

Spatial Features/Characteristics
```{r}
library(ggplot2)

polybox <- function(x, y, w = 0.0025, crs = 4326) {
  dw <- cbind(c(x - w, x + w, x + w, x - w, x - w),
              c(y + w, y + w, y - w, y - w, y + w))
  st_sf(geometry = st_sfc(st_polygon(list(dw))), crs = crs)
}

set.seed(2)
site <- ctlg %>% 
  filter(nflds > 0) %>% 
  sample_n(1) %>% 
  select(name, assignment_id, nflds, farea, x, y) %>% 
  mutate(polybox(x, y)) %>% 
  st_as_sf()

p <- ggplot() +
  geom_sf(data = site) +
  theme_linedraw()
p
```

Digitized Boundaries
```{r}
ctlg %>% 
  mutate(flds = ifelse(nflds > 0, 1, nflds)) %>% 
  group_by(Class) %>% 
  summarize(hasflds = sum(flds),
            noflds = length(flds[flds == 0]))

site_flds <- flds %>% 
  filter(assignment_id == site$assignment_id)
site_flds

site

p2 <- p +
  geom_sf(data = site_flds, fill = "transparent", color = "red", lwd = 0.5)
p2
```

Label Uncertainty
```{r}
sites_mapped_gt2 <- ctlg %>% 
  group_by(Class, name) %>% 
  count() %>% 
  ungroup() %>% 
  filter(n > 2)

set.seed(10)
multi_site <- sites_mapped_gt2 %>% slice(9)

# Clarification: assignments = 'assns'
multi_site_assns <- ctlg %>% filter(name == multi_site$name)

target <- multi_site_assns %>% 
  slice(1) %>% 
  mutate(polybox(x, y)) %>% 
  st_as_sf()

# rasterize at 224, 224 pixels
r <- rast(ext(target), nrows = 224, ncols = 224, crs = "EPSG:4326")
values(r) <- 0

multi_site_assnsr <- lapply(1:nrow(multi_site_assns), function(x) {
  assn <- multi_site_assns[x, ]
  if(assn$nflds > 0) {
    assn_flds <- flds %>%
      filter(assignment_id == assn$assignment_id)
    r <- rasterize(assn_flds, r, background = 0)
  } else {
    r
  }
  return(r)
}) %>% do.call(c, .)

plot(multi_site_assnsr)

pfield <- app(multi_site_assnsr, sum) / nlyr(multi_site_assnsr)
plot(pfield)
```


```{r}
thresholds <- seq(0, 1, 0.2)
reclmat <- data.frame(
  lower = thresholds[-length(thresholds)],
  upper = thresholds[-1],
  index = 1:5,
  class = c("No field, high confidence", "No field, medium confidence", "Uncertain", "Field, medium confidence", "Field, high confidence")
)

conf_class <- classify(pfield, rcl = reclmat[, -4], include.lowest = TRUE)

levels(conf_class) <- reclmat[, 3:4]

plot(conf_class, mar = c(0, 1, 0, 12))
```

```{r, warning = FALSE}
conf_table <- freq(conf_class)
conf_table


nofld <- mask(1 - pfield, pfield < 0.5, maskvalue = 0, updatevalue = 0)

fld <- mask(pfield, pfield >= 0.5, maskvalue = 0, updatevalue = 0)

fld_nofld_conf <- c(fld, nofld, fld + nofld)

names(fld_nofld_conf) <- c("field agreement", "no field agreement", "overall agreement")

plot(fld_nofld_conf, nr = 1)

global(fld_nofld_conf[[3]], mean)
```

